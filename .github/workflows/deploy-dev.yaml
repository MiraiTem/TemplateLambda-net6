name: deploy-dev

on:
  push:
    branches:
        - develop

env:
    AWS_REGION: 'sa-east-1'
    TERRAFORM_VERSION: '1.0.9'

jobs:
  build: 
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v3

    - name: install dotnet 6
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
    
    - name: build
      run: |
        cd $(yq e '.DOTNET_WORKING_DIR' pipeline.yaml)
        dotnet build --configuration Release
  
    - name: Install Terraform
      uses: hashicorp/setup-terraform@v2
      with:
       terraform_version: ${{ env.TERRAFORM_VERSION }}
       cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}      
    
    - name: initialize Terraform
      run: |
       cd $(yq e '.TERRAFORM_WORKING_DIR' pipeline.yaml)
       terraform init

    - name: setup provider
      run: |
       cd $(yq e '.TERRAFORM_WORKING_DIR' pipeline.yaml)
       touch provider.tf
       echo -e "provider \"aws\" { \n access_key = ${{ secrets.AWS_API_KEY_DEV }} \n secret_key = ${{ secrets.AWS_API_SECRET_DEV }} \n }" > provider.tf
       cat provider.tf

    - name: Deploy Lambda with Terraform
      run: |
       cd $(yq e '.TERRAFORM_WORKING_DIR' pipeline.yaml)
       terraform apply -var-file="ambiente/dev.tfvars" -auto-approve
    
      
      



